# FastAPI AI项目详细分析

## 🏗️ 项目概述

这是一个基于FastAPI的**AI智能助手后端服务**，主要服务于两个核心业务：
- **StoneAI（极小妹）**: 智能对话助手，包含日程管理、用户画像等功能
- **易拍居**: 房地产相关的AI对话服务

## 📁 项目架构

### 整体架构模式
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Controller    │    │     Service     │    │       DAO       │
│   (控制层)      │───▶│   (业务逻辑层)   │───▶│   (数据访问层)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘ 
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│      POJO       │    │       AI        │    │       DB        │
│   (数据模型)    │    │   (AI服务层)    │    │   (数据库层)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🎯 核心功能模块

### 1. 🤖 AI智能服务模块 (`src/ai/`)
- **OpenAI集成**: 封装OpenAI API调用
- **DashScope集成**: 阿里云AI服务集成
- **AI服务统一接口**: 提供统一的AI调用接口

### 2. 👤 用户画像模块 (`src/controller/ai/userProfileController.py`)
**功能**: 用户行为分析和个性化服务
- 用户语言风格分析
- 偏好问题分析
- 性格特征分析
- 行为画像构建
- 情感倾向跟踪

**主要接口**:
- `POST /user-profile/analysis/language-style` - 语言风格分析
- `POST /user-profile/analysis/preference-questions` - 偏好问题分析
- `POST /user-profile/analysis/personality-traits` - 性格特征分析

### 3. 📅 日程任务管理 (`src/controller/ai/scheduleTaskController.py`)
**功能**: 智能日程和任务管理
- 日程创建、更新、删除
- 任务优先级管理（重要/紧急）
- 过期任务提醒
- 即将到期任务提醒
- 批量操作支持

**主要接口**:
- `POST /app/schedule-tasks` - 创建日程任务
- `GET /app/schedule-tasks/ending-soon` - 获取即将到期的任务
- `GET /app/schedule-tasks/overdue` - 获取过期任务
- `POST /app/schedule-tasks/complete` - 标记任务完成

### 4. 💬 会话管理 (`src/controller/ai/sessionController.py`)
**功能**: 对话会话管理
- 会话创建和维护
- 对话历史记录
- 会话语义分析
- 多轮对话支持

### 5. 🏢 ERP业务模块 (`src/controller/business/erpController.py`)
**功能**: 企业资源规划相关功能
- SQL查询执行
- PO/PI文档生成
- 订单搜索和分析
- 库存详情查询
- 销售信息分析

**主要接口**:
- `POST /erp/execute-sql-query` - 执行SQL查询
- `POST /erp/generate_popi` - 生成PO/PI文档
- `POST /erp/order_search` - 订单搜索
- `POST /erp/inventory_detail` - 库存详情查询

### 6. 🏠 易拍居模块 (`src/controller/business/ypjController.py`)
**功能**: 房地产相关AI服务
- 房产信息查询
- 市场分析
- 投资建议

### 7. 🔗 Dify集成模块 (`src/controller/dify/difyController.py`)
**功能**: 与Dify平台集成
- 极小妹对话流 (`/dify/chatflow-jxm`)
- 易拍居对话流 (`/dify/chatflow-ypj`)
- 流式响应支持
- 用户信息获取

### 8. 📁 文件管理 (`src/controller/common/fileUploadsController.py`)
**功能**: 文件上传和管理
- 文件上传
- 文件下载
- 文件列表管理
- 文件删除

## 🗄️ 数据库设计

### 核心数据表

#### 1. `api_info` - API信息表
- 存储各种API的配置信息
- 支持API参数模板和描述

#### 2. `session` - 会话表
- 存储用户对话会话信息
- 包含Dify会话ID映射
- 支持会话语义分析

#### 3. `session_detail` - 会话详情表
- 存储每次对话的详细信息
- 包含API输入输出记录
- 支持对话流程日志

#### 4. `user_profile` - 用户画像表
- 用户语言风格偏好
- 性格特征分析
- 行为画像数据

#### 5. `app_schedule_task` - 日程任务表
- 任务类型和状态管理
- 优先级标记（重要/紧急）
- 时间管理（开始/结束时间）

## 🔧 技术栈

### 后端技术
- **FastAPI**: 现代Python Web框架
- **SQLModel**: 基于SQLAlchemy的ORM
- **MySQL**: 主数据库
- **Uvicorn**: ASGI服务器

### AI集成
- **OpenAI API**: GPT模型集成
- **DashScope**: 阿里云AI服务
- **Dify**: 低代码AI平台集成

### 部署和运维
- **Docker**: 容器化部署
- **Docker Compose**: 多服务编排
- **静态文件服务**: Swagger UI本地化

## 🚀 部署架构

### 开发环境
```
┌─────────────────┐
│   FastAPI App   │
│   (Port: 8000)  │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│     MySQL       │
│   (Port: 3306)  │
└─────────────────┘
```

### 生产环境
```
┌─────────────────┐    ┌─────────────────┐
│   Docker App    │    │   Dify Server   │
│   (Port: 8000)  │◄──►│   (Port: 5000)  │
└─────────────────┘    └─────────────────┘
         │
         ▼
┌─────────────────┐
│   MySQL Server  │
│   (Port: 3306)  │
└─────────────────┘
```

## 📊 业务流程图

### 用户对话流程
```
用户输入 → 用户画像分析 → Dify对话流 → AI处理 → 响应返回
    │           │              │           │
    ▼           ▼              ▼           ▼
会话记录 → 偏好更新 → 流式响应 → 结果存储
```

### 日程管理流程
```
创建任务 → 优先级分析 → 时间管理 → 提醒通知 → 任务完成
    │           │           │           │
    ▼           ▼           ▼           ▼
用户画像 → 智能建议 → 自动调度 → 状态更新
```

## 🎯 核心特性

### 1. 智能化
- **用户画像**: 基于对话历史分析用户偏好
- **个性化响应**: 根据用户特征调整回复风格
- **智能日程**: 基于用户行为优化任务安排

### 2. 可扩展性
- **模块化设计**: 清晰的MVC架构
- **插件化AI**: 支持多种AI服务集成
- **配置化**: 通过数据库配置API参数

### 3. 高可用性
- **异常处理**: 完善的错误处理机制
- **日志记录**: 详细的请求和错误日志
- **健康检查**: 服务状态监控

### 4. 开发友好
- **自动API文档**: Swagger UI集成
- **热重载**: 开发环境支持代码热重载
- **调试支持**: 完善的调试配置

## 🔍 访问方式

### API文档
```
http://localhost:8000/docs
```

### 主要业务接口
- **用户画像**: `/user-profile/*`
- **日程管理**: `/app/schedule-tasks/*`
- **ERP业务**: `/erp/*`
- **易拍居**: `/ypj/*`
- **Dify集成**: `/dify/*`
- **文件管理**: `/common/file-uploads/*`

## 📈 项目优势

1. **业务导向**: 针对具体业务场景设计
2. **AI集成**: 深度集成多种AI服务
3. **用户中心**: 基于用户画像的个性化服务
4. **可维护性**: 清晰的代码结构和文档
5. **可扩展性**: 模块化设计便于功能扩展

## 🚀 未来发展方向

1. **多模态支持**: 集成图像、语音处理
2. **实时协作**: 支持多用户实时协作
3. **移动端优化**: 针对移动设备的API优化
4. **数据分析**: 更深入的业务数据分析
5. **微服务化**: 逐步拆分为微服务架构 